"use strict";angular.module("giftableApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","firebase.ref","firebase.auth","angularModalService","ImageCropper","ui.bootstrap","toastr","angular-google-analytics","ngSanitize","angularMoment","ui.bootstrap"]),angular.module("giftableApp").controller("MainCtrl",["$scope","$location",function(a,b){a.pageClass="page-main",a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.join=function(){b.path("/people")}}]),angular.module("firebase.config",[]).constant("FBURL","https://giftable.firebaseio.com").constant("SIMPLE_LOGIN_PROVIDERS",["password"]).constant("loginRedirectPath","/login"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("giftableApp").controller("ChatCtrl",["$scope","Ref","$firebaseArray","$timeout",function(a,b,c,d){function e(b){a.err=b,d(function(){a.err=null},5e3)}a.messages=c(b.child("messages").limitToLast(10)),a.messages.$loaded()["catch"](e),a.addMessage=function(b){b&&a.messages.$add({text:b})["catch"](e)}}]),angular.module("giftableApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(){angular.module("firebase.auth",["firebase","firebase.ref"]).factory("Auth",["$firebaseAuth","Ref",function(a,b){return a(b)}])}(),angular.module("giftableApp").controller("NavCtrl",["$scope","$location","Ref","$firebaseObject","$firebaseAuth",function(a,b,c,d,e){var f=e(c);f.$onAuth(function(b){a.currentUser=d(c.child("users").child(b.uid)),console.log("auth changed"),console.log(b.uid)}),a.isCurrentPath=function(a){return b.path()===a}}]),angular.module("giftableApp").controller("LoginCtrl",["$scope","Auth","$location","$q","Ref","$timeout","Analytics","toastr","ModalService",function(a,b,c,d,e,f,g,h,i){function j(){c.path("/people")}function k(b){if(b)switch(b.code){case"INVALID_EMAIL":a.err="Email is invalid.";break;case"INVALID_PASSWORD":a.err="Password incorrect.";break;case"INVALID_USER":a.err="User account does not exist.";break;case"EMAIL_TAKEN":a.err="Email already taken.";break;case"NETWORK_ERROR":a.err="An error occurred while attempting to contact the authentication server.";break;default:a.err="Error logging user in:"+b}}function l(a){h.success(a)}a.pageClass="page-login",a.passwordLogin=function(c,d){a.err=null,c?d?b.$authWithPassword({email:c,password:d},{rememberMe:!0}).then(j,k):a.err="Please enter a password":a.err="Please enter your email address"},a.forgotPassword=function(){i.showModal({templateUrl:"views/forgotpassword.html",controller:"ModalCtrl"}).then(function(d){d.element.modal(),d.close.then(function(d){a.formData=d,"Cancel"!==a.formData&&(console.log("would have reset here"),console.log(d.email),b.$resetPassword({email:d.email}).then(function(){l("Password reset.  Email sent to the specified address with instructions."),c.path("views/updatePassword.html")},k))})})},a.createAccount=function(c,i,l,m){function n(a){var b=e.child("users/"+a.uid),i=d.defer();return b.set({email:c,name:l},function(c){f(function(){c?i.reject(c):(h.success("Account created"),g.trackEvent("profile","account created",a.uid),i.resolve(b))})}),i.promise}a.err=null,i?l?i!==m?a.err="Passwords do not match":b.$createUser({email:c,password:i}).then(function(){return b.$authWithPassword({email:c,password:i},{rememberMe:!0})}).then(n).then(j,k):a.err="Please enter a display name":a.err="Please enter a password"}}]),angular.module("giftableApp").controller("AccountCtrl",["$scope","user","Auth","Ref","$firebaseObject","$timeout","toastr","Analytics",function(a,b,c,d,e,f,g,h){function i(a){g.error(a)}function j(a){g.success(a)}a.pageClass="page-account",a.user=b,a.logout=function(){c.$unauth()},a.messages=[];var k=e(d.child("users/"+b.uid));k.$bindTo(a,"profile"),a.changePassword=function(d,e,f){a.err=null,d&&e?e!==f?i("Passwords do not match"):c.$changePassword({email:k.email,oldPassword:d,newPassword:e}).then(function(){j("Password changed"),h.trackEvent("profile","password changed",b.uid)},i):i("Please enter all fields")},a.save=function(){j("Name changed!"),h.trackEvent("profile","name changed",b.uid)},a.changeEmail=function(d,e){a.err=null,c.$changeEmail({password:d,newEmail:e,oldEmail:k.email}).then(function(){k.email=e,k.$save(),j("Email changed"),h.trackEvent("profile","email changed",b.uid)})["catch"](i)}}]),angular.module("giftableApp").directive("ngShowAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("giftableApp").directive("ngHideAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("giftableApp").config(["AnalyticsProvider",function(a){a.setAccount({tracker:"UA-72222778-1",trackEvents:!0}).trackPages(!0).useDisplayFeatures(!0).useEnhancedLinkAttribution(!0)}]).config(["toastrConfig",function(a){angular.extend(a,{autoDismiss:!0,containerId:"toast-container",maxOpened:0,newestOnTop:!0,positionClass:"toast-top-right",preventDuplicates:!1,preventOpenDuplicates:!0,target:"body",iconClasses:{error:"giftable-error",info:"toast-info",success:"giftable-success",warning:"toast-warning"},tapToDismiss:!0,closeButton:!0})}]).config(["$routeProvider","SECURED_ROUTES",function(a,b){a.whenAuthenticated=function(c,d){return d.resolve=d.resolve||{},d.resolve.user=["Auth",function(a){return a.$requireAuth()}],a.when(c,d),b[c]=!0,a}}]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/updatePassword",{templateUrl:"views/updatepassword.html",controller:"UpdatepasswordCtrl"}).whenAuthenticated("/chat",{templateUrl:"views/chat.html",controller:"ChatCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).whenAuthenticated("/person/:id",{templateUrl:"views/person.html",controller:"PersonCtrl"}).whenAuthenticated("/account",{templateUrl:"views/account.html",controller:"AccountCtrl"}).whenAuthenticated("/people",{templateUrl:"views/people.html",controller:"PeopleCtrl"}).whenAuthenticated("/gift/:id",{templateUrl:"views/gift.html",controller:"GiftCtrl"}).whenAuthenticated("/event/:id",{templateUrl:"views/event.html",controller:"EventCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","Auth","SECURED_ROUTES","loginRedirectPath","Analytics",function(a,b,c,d,e,f){function g(a){!a&&h(b.path())?b.path(e):f.set("&uid",a.uid)}function h(a){return d.hasOwnProperty(a)}c.$onAuth(g),a.$on("$routeChangeError",function(a,c,d,f){"AUTH_REQUIRED"===f&&b.path(e)})}]).constant("SECURED_ROUTES",{}),angular.module("giftableApp").controller("PeopleCtrl",["$scope","toastr","Ref","$firebaseArray","$timeout","$location","ModalService","Analytics",function(a,b,c,d,e,f,g,h){function i(b){a.err=b,e(function(){a.err=null},5e3)}a.pageClass="page-people";var j=c.getAuth();a.people=[],e(function(){a.people=d(c.child("person").orderByChild("createdBy").equalTo(j.uid)),a.people.$loaded()["catch"](i)}),a.goToPerson=function(a){a&&f.path("/person/"+a)},a.addGiftee=function(){g.showModal({templateUrl:"views/addGiftee.html",controller:"ModalCtrl"}).then(function(c){c.element.modal(),c.close.then(function(c){a.formData=c,"Cancel"!==a.formData&&a.people.$add({firstName:c.firstName,lastName:c.lastName,city:c.city||"",state:c.state||"",address:c.address||"",zipcode:c.zipcode||"",createdAt:(new Date).toJSON(),createdBy:j.uid})["catch"](i).then(function(){b.success("Giftee created!"),h.trackEvent("giftee","added",c.firstName+c.lastName)})})})}}]),angular.module("giftableApp").controller("PersonCtrl",["$scope","toastr","$routeParams","PersonSvc","Ref","$firebaseArray","ModalService","$timeout","$location","Analytics","moment",function(a,b,c,d,e,f,g,h,i,j,k){function l(){var b={};a.joinedEvents.forEach(function(a){b[a.$id]=null,s.update(b)})}function m(){var b={};a.joinedGifts.forEach(function(a){b[a.$id]=null,t.update(b)})}function n(){var c=a.person.firstName,d=a.person.lastName;a.person.$remove(),i.path("/people"),b.success(c+" has been deleted"),j.trackEvent("giftee","deleted",c+" "+d)}function o(b){a.err=b,h(function(){a.err=null},5e3)}var p=e.getAuth();a.pageClass="page-person",a.id=c.id,a.giftsRef=new Firebase.util.NormalizedCollection([e.child("person/"+a.id+"/gifts"),"person"],[e.child("gifts"),"gifts"]).select("gifts.title","gifts.cost","gifts.description","gifts.interestLevel","gifts.status",{key:"person.$value",alias:"test"}).ref(),a.eventsRef=new Firebase.util.NormalizedCollection([e.child("person/"+a.id+"/events"),"person"],[e.child("events"),"events"]).select("events.eventTitle","events.eventDescription","events.eventDate","events.createdBy","events.createdAt","events.createdFor",{key:"person.$value",alias:"test"}).ref(),a.person=d.getPerson(a.id),a.people=f(e.child("person").orderByChild("createdBy").equalTo(p.uid)),a.globalGifts=f(e.child("gifts")),a.globalEvents=f(e.child("events")),a.personGifts=f(e.child("person/"+a.id+"/gifts")),a.joinedGifts=f(a.giftsRef),a.joinedEvents=f(a.eventsRef),a.events=f(e.child("person/"+a.id+"/events")),a.max=5,a.isReadonly=!0;var q=e.child("person/"+a.id+"/events"),r=e.child("person/"+a.id+"/gifts"),s=e.child("events"),t=e.child("gifts"),u=k(new Date);a.editGiftee=function(){g.showModal({templateUrl:"views/editGiftee.html",controller:"PersonModalCtrl",inputs:{firstName:a.person.firstName,lastName:a.person.lastName,city:a.person.city,state:a.person.state,address:a.person.address,zipcode:a.person.zipcode}}).then(function(c){c.element.modal(),c.close.then(function(c){a.formData=c,"Cancel"!==a.formData&&(a.person.firstName=c.firstName,a.person.lastName=c.lastName,a.person.city=c.city||"",a.person.state=c.state,a.person.address=c.address||"",a.person.zipcode=c.zipcode||"",a.person.$save()["catch"](o).then(function(){b.success(c.firstName+" updated"),j.trackEvent("giftee","updated",c.firstName+" "+c.lastName)}))})})},a.deleteGiftee=function(){g.showModal({templateUrl:"views/deleteGiftee.html",controller:"PersonModalCtrl",inputs:{firstName:a.person.firstName,lastName:a.person.lastName,city:a.person.city,state:a.person.state,address:a.person.address,zipcode:a.person.zipcode}}).then(function(a){a.element.modal(),a.close.then(function(a){"yes"===a.confirm&&(l(),m(),n())})})},a.addGift=function(){g.showModal({templateUrl:"views/addGift.html",controller:"ModalCtrl"}).then(function(c){c.element.modal(),c.close.then(function(c){a.formData=c,"Cancel"!==a.formData&&a.globalGifts.$add({title:c.title,description:c.description||"",url:c.url||"",cost:c.cost||"",interestLevel:c.interestLevel||"",status:"new",createdAt:(new Date).toJSON(),createdBy:p.uid,createdFor:a.id})["catch"](o).then(function(d){var e=d.key();a.createNewGiftOnPerson(e),b.success("Gift created!"),j.trackEvent("gift","added",c.title)})})})},a.addEvent=function(){g.showModal({templateUrl:"views/addEvent.html",controller:"ModalCtrl"}).then(function(c){c.element.modal(),c.close.then(function(c){a.formData=c,"Cancel"!==a.formData&&a.globalEvents.$add({eventTitle:c.title,eventDescription:c.description||"",eventDate:c.eventTime.toJSON(),createdAt:(new Date).toJSON(),createdFor:a.id,createdBy:p.uid,notificationTime:c.notificationTime.toJSON(),notificationDays:c.notificationDays,notification:"pending"})["catch"](o).then(function(d){var e=d.key();a.createNewEventOnPerson(e),b.success("Event created!"),j.trackEvent("event","added",c.title)})})})},a.createNewGiftOnPerson=function(a){var b=a,c="true",d={};d[b]=c,r.update(d)},a.createNewEventOnPerson=function(a){var b=a,c="true",d={};d[b]=c,q.update(d)},a.isCreator=function(){return a.person.createdBy===p.uid?!0:!1},a.goToGift=function(a){a&&i.path("/gift/"+a)},a.goToEvent=function(a){a&&i.path("/event/"+a)},a.calculateDaysAway=function(a){var b=k(a),c=b.diff(u,"days");return 0>c&&(c=0),c},a.getProximityColor=function(b){var c=a.calculateDaysAway(b);return c>14?"green":c>7&&14>c?"yellow":c>0&&7>c?"red":0===c?"death":void 0},a.getGiftStatusColor=function(a){var b={"new":"newGift",ordered:"orderedGift",ready:"readyGift",given:"givenGift"};return b[a]}}]),angular.module("giftableApp").factory("PersonSvc",["Ref","$firebaseArray","$firebaseObject",function(a,b,c){function d(){return b(h)}function e(a){return c(h.child(a))}function f(a){return b(h.child(a+"/events"))}function g(a,b){var d=h.child(a+"/events/"+b);return console.log(d.toString()),c(h.child(a+"/events/"+b))}var h=a.child("person");return{getPerson:e,getPersons:d,getPersonEvents:f,getPersonEvent:g}}]),angular.module("giftableApp").controller("ModalCtrl",["$scope","close",function(a,b){function c(a,b){var c=a.setDate(a.getDate()-b);return new Date(c)}var d=new Date,e=new Date;d.setDate(d.getDate()+1),e.setDate(d.getDate()+2),a.rate=7,a.max=5,a.isReadonly=!1,a.hoveringOver=function(b){a.overStar=b,a.percent=100*(b/a.max)},a.imageCropStep="1",a.events=[{date:d,status:"full"},{date:e,status:"partially"}],a.dateOptions={formatYear:"yy",startingDay:1},a.format="MMMM dd, yyyy",a.status={opened:!1},a.close=function(a,d,e){a.eventTime=d,a.notificationTime=c(new Date(d),e),a.notificationDays=e,b(a,500)},a.today=function(){a.dt=new Date},a.today(),a.clear=function(){a.dt=null},a.disabled=function(a,b){return"day"===b&&(0===a.getDay()||6===a.getDay())},a.toggleMin=function(){a.minDate=a.minDate?null:new Date},a.toggleMin(),a.openEvent=function(){a.status.openedEventTime=!0},a.openNotification=function(){a.status.openedNotification=!0},a.getDayClass=function(b,c){if("day"===c)for(var d=new Date(b).setHours(0,0,0,0),e=0;e<a.events.length;e++){var f=new Date(a.events[e].date).setHours(0,0,0,0);if(d===f)return a.events[e].status}return""},a.confirm=function(a){var c={};c.confirm=a,b(c,500)}}]),angular.module("giftableApp").controller("GiftCtrl",["$scope","$window","$timeout","Ref","$routeParams","GiftSvc","ModalService","$location","toastr","Analytics",function(a,b,c,d,e,f,g,h,i,j){a.pageClass="page-gift",a.test="https://www.google.com",a.giftId=e.id,a.gift=new f(a.giftId),a.rate=7,a.max=5,a.isReadonly=!0;var k=d.child("gifts/"+a.giftId),l={};c(function(){l=d.child("person/"+a.gift.createdFor+"/gifts/"+a.giftId)},500),a.editMode=!0,a.hoveringOver=function(b){a.overStar=b,a.percent=100*(b/a.max)},a.edit=function(){a.editMode=!1,a.isReadonly=!1},a.save=function(b){k.update({title:b.title,cost:b.cost||"",description:b.description||"",url:b.url||"",interestLevel:b.interestLevel||"",status:b.status||""},m),a.cancel()},a.cancel=function(){a.editMode=!0,a.isReadyonly=!0},a["return"]=function(a){h.path("/person/"+a)},a["delete"]=function(){var b=a.gift.createdFor;l.remove(n),k.remove(n),a["return"](b)},a.deleteItem=function(){g.showModal({templateUrl:"views/confirm.html",controller:"ModalCtrl"}).then(function(b){b.element.modal(),b.close.then(function(b){"yes"===b.confirm&&a["delete"]()})})},a.goToGift=function(a){b.open(a,"_blank")};var m=function(b){b?i.error("Oops!","An error happened.  Detail: "+b):(i.success("Changes saved!"),j.trackEvent("gift","edited",a.gift.title))},n=function(b){b?i.error("Oops!","An error happened.  Detail: "+b):(i.success("Item deleted"),j.trackEvent("gift","deleted",a.gift.title))}}]),angular.module("giftableApp").service("GiftSvc",["$firebaseObject",function(a){var b=new Firebase("https://giftable.firebaseio.com").child("gifts");return function(c){return a(b.child(c))}}]),angular.module("giftableApp").controller("EventCtrl",["$scope","$q","Ref","$routeParams","EventSvc","PersonSvc","$location","ModalService","toastr","Analytics",function(a,b,c,d,e,f,g,h,i,j){function k(a){i.error("Oops!","An error happened.  Detail: "+a)}function l(a,b){var c=a.setDate(a.getDate()-b);return new Date(c)}a.pageClass="page-event",a.eventId=d.id,a.event=e.getEvent(a.eventId),a.eventRaw=e.getEventRaw(a.eventId),a.event.$loaded().then(function(){a.personEvent=f.getPersonEvent(a.event.createdFor,a.eventId)}),a.editMode=!1,a.format="MMMM dd, yyyy",a.dateOptions={formatYear:"yy",startingDay:1},a.status={opened:!1},a.openNotification=function(){a.status.openedNotification=!0},a.openEvent=function(){a.status.openedEventTime=!0},a.edit=function(){a.editMode=!0},a.save=function(b){a.eventRaw.update({eventTitle:b.eventTitle,eventDescription:b.eventDescription||"",eventDate:b.eventDate,notificationDays:b.notificationDays,notificationTime:l(new Date(b.eventDate),b.notificationDays)},function(b){b?k(b):(i.success("Changes saved!"),j.trackEvent("event","edited",a.event.eventTitle))}),a.cancel()},a.cancel=function(){a.editMode=!1},a["return"]=function(a){g.path("/person/"+a)},a["delete"]=function(){var b=a.event.createdFor;a.personEvent.$remove()["catch"](k),a.event.$remove()["catch"](k).then(function(){i.success("Item deleted"),j.trackEvent("event","deleted",a.event.eventTitle)}),a["return"](b)},a.deleteItem=function(){h.showModal({templateUrl:"views/confirm.html",controller:"ModalCtrl"}).then(function(b){b.element.modal(),b.close.then(function(b){"yes"===b.confirm&&a["delete"]()})})}}]),angular.module("giftableApp").factory("EventSvc",["Ref","$firebaseArray","$firebaseObject",function(a,b,c){function d(){return b(g)}function e(a){return g.child(a)}function f(a){return c(g.child(a))}var g=a.child("events");return{getEvents:d,getEvent:f,getEventRaw:e}}]),angular.module("giftableApp").controller("UpdatepasswordCtrl",["$scope","Auth","Ref","toastr","$location","Analytics",function(a,b,c,d,e,f){function g(a){d.error(a)}function h(a){d.success(a)}a.pageClass="page-update-password",a.updatePassword=function(c,d,i,j){a.err=null,d&&i?i!==j?g("Passwords do not match"):b.$changePassword({email:c,oldPassword:d,newPassword:i}).then(function(){h("Password changed.  Redirecting for login..."),f.trackEvent("profile","password changed",c)},g).then(function(){e.path("/login")}):g("Please enter all fields")},a.cancel=function(){e.path("/")}}]),angular.module("giftableApp").controller("PersonModalCtrl",["$scope","close","firstName","lastName","city","state","address","zipcode",function(a,b,c,d,e,f,g,h){a.person={firstName:c,lastName:d,city:e,state:f,address:g,zipcode:h},a.close=function(a){b(a,500)}}]);